<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة الدوام والإضافي — عرض أسبوعي مثل الرزنامة</title>
  <style>
    :root{--bg:#0b1020;--card:#0e1528;--ink:#e5e7eb;--muted:#94a3b8;--line:#1f2b40;--ok:#16a34a;--warn:#ef4444;--accent:#60a5fa}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic",Tahoma,Arial,sans-serif}
    .wrap{max-width:1060px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-size:clamp(20px,3vw,28px)}
    p.small{color:var(--muted);margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 220px}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0a1222;color:var(--ink)}
    input[type="time"], input[type="date"], input[type="number"]{direction:ltr}
    button{cursor:pointer}
    .primary{background:linear-gradient(180deg,#16a34a,#15803d);border:none}
    .ghost{background:transparent}
    .muted{color:var(--muted)}/* تقويم أسبوعي */
.weekbar{display:flex;align-items:center;gap:8px;margin:8px 0 12px}
.btn{padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:#0a1222;color:var(--ink)}
.btn:disabled{opacity:.6}
.pill{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#0a1222}

.calendar{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
@media (max-width:900px){.calendar{grid-template-columns:repeat(3,1fr)}}
@media (max-width:560px){.calendar{grid-template-columns:1fr}}

.day{display:flex;flex-direction:column;gap:8px;border:1px solid var(--line);background:#0a1222;border-radius:14px;padding:12px}
.dayHeader{display:flex;justify-content:space-between;align-items:center}
.title{font-weight:700}
.badge{font-size:12px;color:var(--muted);border:1px dashed var(--line);padding:4px 8px;border-radius:10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.kpi{display:flex;flex-wrap:wrap;gap:8px}
.tag{font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
.tag.ok{border-color:#14532d}
.tag.warn{border-color:#7f1d1d}

.kpis{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin-top:8px}
.kcard{border:1px solid var(--line);background:#0a1222;border-radius:12px;padding:12px;text-align:center}
.kcard h3{margin:0;color:var(--muted);font-size:12px}
.kcard .val{font-size:20px;font-weight:700;margin-top:6px}
.sep{height:1px;background:var(--line);margin:14px 0}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>حاسبة الدوام والإضافي — عرض أسبوعي مثل الرزنامة</h1>
      <p class="small">واجهة بسيطة تشبه الرزنامة: لكل يوم بطاقة مستقلة تدخل فيها <strong>وقت البدء</strong> و<strong>وقت الانتهاء</strong> و<strong>الاستراحة (دقائق)</strong>. الحاسبة تخصم الاستراحة وتعرض الصافي والإضافي لكل يوم، مع ملخص أسبوعي.</p><div class="row">
    <div class="col">
      <label>ابدأ من أسبوع (اختر تاريخ يوم الاثنين)</label>
      <input type="date" id="weekStart" />
    </div>
    <div class="col">
      <label>الأساس اليومي (ساعات)</label>
      <input id="baselineDay" type="number" min="0" step="0.25" value="8" />
    </div>
    <div class="col">
      <label>الأساس الأسبوعي (ساعات)</label>
      <input id="baselineWeek" type="number" min="0" step="0.5" value="40" />
    </div>
    <div class="col">
      <label>استراحة افتراضية (دقائق)</label>
      <input id="defaultBreak" type="number" min="0" step="5" value="30" />
    </div>
  </div>

  <div class="weekbar">
    <button class="btn" id="prevWeek">⟵ الأسبوع السابق</button>
    <span class="pill" id="rangeLbl">—</span>
    <button class="btn" id="nextWeek">الأسبوع التالي ⟶</button>
    <span class="muted" style="margin-inline-start:auto">* السبت اختياري</span>
  </div>

  <div class="calendar" id="calendar"></div>

  <div class="sep"></div>
  <div class="kpis">
    <div class="kcard"><h3>مجموع الأسبوع</h3><div class="val" id="kTotal">0:00</div></div>
    <div class="kcard"><h3>إضافي أسبوعي</h3><div class="val" id="kOTWeek">0:00</div></div>
    <div class="kcard"><h3>معدل اليوم (المدخل)</h3><div class="val" id="kAvg">0:00</div></div>
    <div class="kcard"><h3>أيام مدخلة</h3><div class="val" id="kDays">0</div></div>
  </div>

  <div class="sep"></div>
  <div class="row">
    <div class="col"><button class="ghost" id="fillExample">تعبئة مثال 07:00→17:30 (استراحة 45)</button></div>
    <div class="col"><button class="ghost" id="clearAll">مسح هذا الأسبوع</button></div>
    <div class="col"><button class="primary" id="exportJson">تصدير الأسبوع (JSON)</button></div>
    <div class="col"><button class="ghost" id="importJson">استيراد أسبوع</button><input id="fileInput" type="file" accept="application/json" style="display:none"></div>
  </div>
</div>

  </div><script>
(function(){
  const days = [
    {key:'mon', name:'الاثنين', offset:0},
    {key:'tue', name:'الثلاثاء', offset:1},
    {key:'wed', name:'الأربعاء', offset:2},
    {key:'thu', name:'الخميس', offset:3},
    {key:'fri', name:'الجمعة', offset:4},
    {key:'sat', name:'السبت (اختياري)', offset:5},
  ];

  const cal = document.getElementById('calendar');
  const weekStartEl = document.getElementById('weekStart');
  const rangeLbl = document.getElementById('rangeLbl');
  const btnPrev = document.getElementById('prevWeek');
  const btnNext = document.getElementById('nextWeek');

  const baselineDayEl = document.getElementById('baselineDay');
  const baselineWeekEl = document.getElementById('baselineWeek');
  const defaultBreakEl = document.getElementById('defaultBreak');

  const kTotal = document.getElementById('kTotal');
  const kOTWeek = document.getElementById('kOTWeek');
  const kAvg = document.getElementById('kAvg');
  const kDays = document.getElementById('kDays');

  const exportBtn = document.getElementById('exportJson');
  const importBtn = document.getElementById('importJson');
  const fileInput = document.getElementById('fileInput');
  const fillExampleBtn = document.getElementById('fillExample');
  const clearAllBtn = document.getElementById('clearAll');

  function fmtDate(d){return d.toISOString().slice(0,10)}
  function parseDate(str){ const [y,m,da]=str.split('-').map(Number); return new Date(y,m-1,da) }

  function startOfWeek(date){
    // اجعل الإثنين بداية الأسبوع حسب ألمانيا
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const day = (d.getDay()+6)%7; // 0=Mon,6=Sun
    d.setDate(d.getDate() - day);
    return d;
  }

  function addDays(date,n){ const d=new Date(date); d.setDate(d.getDate()+n); return d }

  function h2m(h){ if(!h) return 0; const [HH,MM]=h.split(':').map(Number); return HH*60+(MM||0) }
  function m2h(m){ const sign=m<0?'-':''; m=Math.abs(m); const hh=Math.floor(m/60); const mm=Math.round(m%60); return `${sign}${hh}:${mm.toString().padStart(2,'0')}` }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function buildDayCard(dayObj, weekStart){
    const d = addDays(weekStart, dayObj.offset);
    const id = dayObj.key;

    const wrap = document.createElement('div'); wrap.className='day'; wrap.dataset.day=id; wrap.dataset.date=fmtDate(d);

    const header = document.createElement('div'); header.className='dayHeader';
    const title = document.createElement('div'); title.className='title'; title.textContent = dayObj.name;
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = d.toLocaleDateString('de-DE');
    header.appendChild(title); header.appendChild(badge);

    const grid = document.createElement('div'); grid.className='grid';
    const s = document.createElement('input'); s.type='time'; s.placeholder='ابدأ';
    const e = document.createElement('input'); e.type='time'; e.placeholder='انتهِ';
    const b = document.createElement('input'); b.type='number'; b.min=0; b.step=5; b.value=defaultBreakEl.value; b.title='استراحة (دقائق)';
    const bLbl = document.createElement('label'); bLbl.textContent='استراحة (د)'; bLbl.style.fontSize='12px'; bLbl.style.color='#94a3b8';

    const bWrap = document.createElement('div'); bWrap.style.display='flex'; bWrap.style.flexDirection='column'; bWrap.appendChild(bLbl); bWrap.appendChild(b);

    grid.appendChild(s); grid.appendChild(e); grid.appendChild(bWrap);

    const kpi = document.createElement('div'); kpi.className='kpi';
    const net = document.createElement('span'); net.className='tag ok'; net.textContent='الصافي: 0:00';
    const ot = document.createElement('span'); ot.className='tag'; ot.textContent='إضافي: 0:00';
    kpi.appendChild(net); kpi.appendChild(ot);

    [s,e,b].forEach(el=> el.addEventListener('input', commit));

    wrap.appendChild(header); wrap.appendChild(grid); wrap.appendChild(kpi);
    return wrap;
  }

  function renderWeek(){
    cal.innerHTML='';
    const start = parseDate(weekStartEl.value);
    const end = addDays(start,5);
    rangeLbl.textContent = `${start.toLocaleDateString('de-DE')} — ${end.toLocaleDateString('de-DE')}`;
    days.forEach(d=> cal.appendChild(buildDayCard(d, start)));
    // بعد بناء الواجهة، حمّل حالة الأسبوع إن وجدت
    loadStateForWeek();
    commit();
  }

  function getDayData(card){
    const inputs = card.querySelectorAll('input');
    const s = inputs[0].value; const e = inputs[1].value; const br = clamp(parseInt(inputs[2].value||0,10),0,600);
    if(!s || !e) return {min:0, ot:0, valid:false};
    let sm = h2m(s); let em = h2m(e); if(em < sm) em += 24*60; // عبور منتصف الليل
    const total = Math.max(0, (em - sm) - br);
    const baseDayMin = Math.round(parseFloat(baselineDayEl.value||8)*60);
    const ot = Math.max(0, total - baseDayMin);
    return {min:total, ot, valid:true};
  }

  function commit(){
    let total=0, daysCount=0, otWeek=0;
    document.querySelectorAll('.day').forEach(card=>{
      const d = getDayData(card);
      const [netEl, otEl] = card.querySelectorAll('.tag');
      netEl.textContent = `الصافي: ${m2h(d.min)}`;
      otEl.textContent = `إضافي: ${m2h(d.ot)}`;
      otEl.className = 'tag ' + (d.ot>0? 'warn':'ok');
      if(d.valid){ total += d.min; otWeek += d.ot; daysCount++; }
    });
    const baseWeekMin = Math.round(parseFloat(baselineWeekEl.value||40)*60);
    kTotal.textContent = m2h(total);
    kOTWeek.textContent = m2h(Math.max(0,total-baseWeekMin));
    kAvg.textContent = daysCount? m2h(Math.round(total/daysCount)) : '0:00';
    kDays.textContent = daysCount;
    saveStateForWeek();
  }

  function saveStateForWeek(){
    const key = 'otCal-'+weekStartEl.value;
    const payload = {
      baselineDay: baselineDayEl.value,
      baselineWeek: baselineWeekEl.value,
      defaultBreak: defaultBreakEl.value,
      days: [...document.querySelectorAll('.day')].map(card=>{
        const inputs = card.querySelectorAll('input');
        return {key: card.dataset.day, date: card.dataset.date, start: inputs[0].value, end: inputs[1].value, breakMin: inputs[2].value};
      })
    };
    localStorage.setItem(key, JSON.stringify(payload));
  }

  function loadStateForWeek(){
    const key = 'otCal-'+weekStartEl.value;
    const raw = localStorage.getItem(key);
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      baselineDayEl.value = s.baselineDay ?? baselineDayEl.value;
      baselineWeekEl.value = s.baselineWeek ?? baselineWeekEl.value;
      defaultBreakEl.value = s.defaultBreak ?? defaultBreakEl.value;
      const map = new Map((s.days||[]).map(r=>[r.key,r]));
      document.querySelectorAll('.day').forEach(card=>{
        const r = map.get(card.dataset.day);
        if(r){
          const inputs = card.querySelectorAll('input');
          inputs[0].value = r.start || '';
          inputs[1].value = r.end || '';
          inputs[2].value = r.breakMin ?? defaultBreakEl.value;
        }
      });
    }catch(e){ console.warn('loadStateForWeek failed', e); }
  }

  function exportJSON(){
    const data = {
      meta:{ app:'OT-Calendar', version:1, weekStart: weekStartEl.value, exportedAt: new Date().toISOString() },
      baseline:{ day: baselineDayEl.value, week: baselineWeekEl.value },
      days:[...document.querySelectorAll('.day')].map(card=>{
        const inputs = card.querySelectorAll('input');
        const d = getDayData(card);
        return { key:card.dataset.day, date: card.dataset.date, start: inputs[0].value, end: inputs[1].value, breakMinutes: inputs[2].value, net: m2h(d.min), dailyOT: m2h(d.ot) };
      })
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href=url; a.download = `week-${weekStartEl.value}.json`; a.click(); URL.revokeObjectURL(url);
  }

  function importJSONFile(file){
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const data = JSON.parse(fr.result);
        if(data.meta && data.meta.weekStart){ weekStartEl.value = data.meta.weekStart; }
        renderWeek();
        if(data.baseline){ baselineDayEl.value = data.baseline.day ?? 8; baselineWeekEl.value = data.baseline.week ?? 40; }
        const map = new Map((data.days||[]).map(r=>[r.key,r]));
        document.querySelectorAll('.day').forEach(card=>{
          const r = map.get(card.dataset.day);
          if(r){ const inputs = card.querySelectorAll('input'); inputs[0].value=r.start||''; inputs[1].value=r.end||''; inputs[2].value=r.breakMinutes ?? defaultBreakEl.value; }
        });
        commit();
      }catch(e){ alert('ملف غير صالح'); }
    };
    fr.readAsText(file);
  }

  function setMondayOnPicker(date){ weekStartEl.value = fmtDate(startOfWeek(date)); }

  // Listeners
  [baselineDayEl, baselineWeekEl, defaultBreakEl].forEach(el=> el.addEventListener('input', commit));
  weekStartEl.addEventListener('change', renderWeek);
  btnPrev.addEventListener('click', ()=>{ const d = parseDate(weekStartEl.value); d.setDate(d.getDate()-7); weekStartEl.value = fmtDate(d); renderWeek(); });
  btnNext.addEventListener('click', ()=>{ const d = parseDate(weekStartEl.value); d.setDate(d.getDate()+7); weekStartEl.value = fmtDate(d); renderWeek(); });

  exportBtn.addEventListener('click', exportJSON);
  importBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', ()=>{ if(fileInput.files && fileInput.files[0]) importJSONFile(fileInput.files[0]); });
  fillExampleBtn.addEventListener('click', ()=>{
    // 07:00 → 17:30 مع استراحة 45
    document.querySelectorAll('.day').forEach((card,i)=>{
      const inputs = card.querySelectorAll('input');
      const preset = [
        ['07:00','17:30',45],
        ['07:00','17:00',30],
        ['07:00','16:00',30],
        ['07:30','15:30',30],
        ['06:00','14:30',30],
        ['', '', 30],
      ][i] || ['', '', 30];
      inputs[0].value=preset[0]; inputs[1].value=preset[1]; inputs[2].value=preset[2];
    });
    commit();
  });
  clearAllBtn.addEventListener('click', ()=>{
    document.querySelectorAll('.day').forEach(card=>{
      const inputs = card.querySelectorAll('input');
      inputs[0].value=''; inputs[1].value=''; inputs[2].value=defaultBreakEl.value;
    });
    commit();
  });

  // Init — اضبط الأسبوع الحالي (الإثنين الأقرب)
  setMondayOnPicker(new Date());
  renderWeek();
})();
</script></body>
</html>
